import { Pool } from "pg";
import dotenv from "dotenv";
import debug from "debug";
import { dbConnectionString } from "./settings";
dotenv.config();

export const pool = new Pool({
  connectionString: dbConnectionString,
});

export const initDb = async () => {
  debug("Initing db...");
  await pool.query(`
    CREATE TABLE IF NOT EXISTS
      update_date (
        id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        description text,
        date_created TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
  `);
  debug("...ready");
};

export const insertRecord = (text) => {
  return pool.query(
    `
    INSERT INTO update_date(description) VALUES ($1) RETURNING *; 
  `,
    [text]
  );
};

export const getMostRecent = () => {
  return pool.query(`
  SELECT * FROM update_date ORDER BY id DESC LIMIT 1;
  `);
};

export const cleanDatabase = () => {
  return pool.query(
    `
    DELETE FROM update_date; 
    `
  );
};
